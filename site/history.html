<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>SEO Ranking - Login to check your past ranking</title>
  <meta name="description" content="With SEO Ranking you can track your current and past google ranking">
  <meta name="author" content="Greycastle">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <link rel="stylesheet" href="css/site.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/css-loader/3.3.3/css-loader.css" integrity="sha512-HrLBWHEIRcc9ZemiLhR34DVdkr81NVqhOtT1fIZGdcY5UmC5JzJAEwuj9B/fcNA6huJ3NQ8KV67CmdM/3H2H3g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="js/humanize.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/humanize-duration/3.27.0/humanize-duration.min.js" integrity="sha512-C6XM91cD52KknT8jaQF1P2PrIRTrbMzq6hzFkc22Pionu774sZwVPJInNxfHNwPvPne3AMtnRWKunr9+/gQR5g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.0.1/firebase-analytics.js";
    import { initializeAuth, sendSignInLinkToEmail, isSignInWithEmailLink, onAuthStateChanged, signInWithEmailLink, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCPVxNQjSUH4lbV4srGxT26YkhYANxj5Fw",
      authDomain: "seoranking-324303.firebaseapp.com",
      projectId: "seoranking-324303",
      storageBucket: "seoranking-324303.appspot.com",
      messagingSenderId: "950631750849",
      appId: "1:950631750849:web:74515513e16bc068560840",
      measurementId: "G-WSP006WNBZ"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = initializeAuth(app, {
      'persistence': browserLocalPersistence
    });

    let currentUser = null;

    function addAuthToken(request) {
      request.setRequestHeader('authorization', `bearer ${currentUser.accessToken}`)
    }

    function load(user) {
      currentUser = user;
      return new Promise(function (resolve, reject) {
        $.ajax({
          beforeSend: addAuthToken,
          contentType: 'application/json',
          dataType: 'json',
          url: 'https://us-central1-seoranking-324303.cloudfunctions.net/get_stats',
          success: function(data) {
            resolve(data)
          }
        })
      })
    }

    onAuthStateChanged(auth, function(user) {
      if (user) {
        load(user).then(function(data) {
          const rankings = data.items.length
          $('#statCreditSpent').text(data.stats.creditsSpent)
          $('#statCreditLeft').text(data.stats.creditsLeft)
          $('#statSchedule').text(data.stats.schedule == 1 ? 'every day' : `every ${data.stats.schedule} days`)
          $('#statRankings').text(`${rankings} ${Humanize.pluralize(rankings, 'keyword')}`)
          const remainingEstimate = Math.floor(data.stats.creditsLeft / ((1 / data.stats.schedule) * rankings))
          $('#statRemaining').text(`${remainingEstimate} ${Humanize.pluralize(remainingEstimate, 'day')}`)

          for (let ranking of data.items) {
            const row = $('tbody').append("<tr></tr>")
            row.append(`<td>${ranking.site}</td>`)
            row.append(`<td>${ranking.keyword}</td>`)

            if (ranking.lastRanking) {
              row.append(`<td>${Humanize.ordinal(ranking.lastRanking)} place</td>`)
              const timestamp = Date.parse(ranking.lastConfirmed)
              row.append(`<td>${humanizeDuration(new Date() - timestamp, { round: true, largest: 1 })} ago</td>`)
              const url = `someservice/${ranking.downloadId}`
              row.append(`<td><a href="${url}">Download past ${ranking.rankings} rankings</a></td>`)
            } else {
              row.append('<td>Pending</td>')
              row.append('<td>Pending</td>')
              row.append('<td>Pending</td>')
            }
          }

          $('#loading').fadeOut(250)
          $('#data').fadeIn(250)
        })
      } else {
        window.location.href = 'login.html'
      }
    })

    function addRanking() {
      const site = $('#site').val()
      const keyword = $('#keyword').val()
      localStorage.setItem('last-site', site)

      $.ajax({
        type: 'POST',
        url: 'https://us-central1-seoranking-324303.cloudfunctions.net/add_ranking_endpoint',
        beforeSend: addAuthToken,
        data: JSON.stringify({ 'rank_site': site, keyword }),
        contentType: 'application/json',
        dataType: 'json',
        success: function(data) {
          console.log(data)
        }
      })

      $('#add-ranking-form input').each(function() { $(this).prop('disabled', true) })
      $('#add-ranking').prop('disabled', true)
      $('#add-ranking').text('Adding..')
    }

    $(document).ready(function() {
      $('#loading').fadeIn(250)

      $('#site').val(localStorage.getItem('last-site'))

      $('#add-ranking').click(function(e) {
        addRanking()
        return false
      })
    })
  </script>

</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container" id="loading">
    <div id="loader" class="loader loader-default is-active" data-half=""></div>
  </div>

  <div class="container hide-default" id="data">
    <section class="header">
      <h2 class="title">History</h2>
      <p>
          Welcome in! Here's your recent history and remaining credits.
      </p>
    </section>

    <div class="page-section">
      <h3>Rank history</h3>
      <table style="width: 100%">
        <thead>
          <tr>
            <th>Site</th>
            <th>Keyword</th>
            <th>Last ranking</th>
            <th>Last confirmed</th>
            <th>Ranking statistics</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>

    <div class="page-section">
      <h3>Add more rankings</h3>
      <p>
        You can add more keywords or sites as well:
      </p>
      <form id="add-ranking-form">
        <div class="row">
          <div class="six columns">
              <label for="keyword">Keyword</label>
              <input placeholder="yummy greens" class="remember-input u-full-width" type="text" id="keyword">

          </div>
          <div class="six columns">
            <label for="site">Site</label>
            <input placeholder="greens.zed" class="remember-input u-full-width" type="text" id="site">
          </div>
        </div>
        <p>
          <button id="add-ranking" class="button-primary" type="button">Add ranking</button>
        </p>
      </form>
    </div>

    <div class="page-section">
      <h3>Credit status</h3>
      <p>
        You have done <b id="statCreditSpent">12</b> rank checks this far and have another <b id="statCreditLeft">18</b> remaining. As you are running a rank check <b id="statSchedule">every day</b> on <b id="statRankings">1 keyword</b> it will last for another <b id="statRemaining">18 days</b>.
      </p>
      <h3>Running out?</h3>
      <p>
        No worries! Right now, this service is completely new and still in BETA so if you need more funds, send me an email at <a href="mailto:david@greycastle.se?subject=I%20need%20more%20credits!">david@greycastle.se</a> and I'll sort it out for free!
      </p>
    </div>

    <div class="page-section">
      <h3>About</h3>
      <p>
          This app is built by <a target="_blank" href="https://twitter.com/almundgrey">David</a> @ <a target="_blank" href="https://greycastle.se">Greycastle</a>, visuals based on the <a target="_blank" href="http://getskeleton.com/">Skeleton</a> css framework. <a href="about.html">About</a> | <a href="pricing.html">Pricing</a>.
      </p>
    </div>
  </div>
</body>
</html>
